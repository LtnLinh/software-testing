name: API Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    env:
      SPRINT: sprint5-with-bugs
      APP_ENV: testing

      APP_KEY: base64:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
    defaults:
      run:
        working-directory: .
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Docker stack (per README)
        run: |
          SPRINT=${{ env.SPRINT }} docker compose up -d

      - name: Wait for services
        run: sleep 10

      - name: Migrate and seed inside container
        run: |
          SPRINT=${{ env.SPRINT }} docker compose exec -T laravel-api php artisan migrate:fresh --seed --no-interaction

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Newman
        run: npm install -g newman

      - name: Register API tests
        run: |
          newman run sprint5-with-bugs/tests/API/collection.json \
            -e sprint5-with-bugs/tests/API/env.json \
            --folder "RegisterAPI" \
            --iteration-data sprint5-with-bugs/tests/API/data/register_test_data.csv

      - name: Login API tests
        run: |
          newman run sprint5-with-bugs/tests/API/collection.json \
            -e sprint5-with-bugs/tests/API/env.json \
            --folder "LoginAPI" \
            --iteration-data sprint5-with-bugs/tests/API/data/login_test_data.csv

      - name: Update User API tests
        run: |
          newman run sprint5-with-bugs/tests/API/collection.json \
            -e sprint5-with-bugs/tests/API/env.json \
            --folder "UpdateUserAPI" \
            --iteration-data sprint5-with-bugs/tests/API/data/update_user_test_data.csv